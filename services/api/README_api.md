# Assistant-Teacher API

Сервис **Assistant-Teacher API** предоставляет HTTP-интерфейс к возможностям системы:

- семантический поиск по материалам курса;
- RAG-ответы на вопросы на основе загруженных лекций;
- суммаризация лекций;
- генерация и оценка квизов;
- переформулирование текста;
- перевод с английского на русский;
- универсальный «ассистент» с автоматическим выбором режима работы.

Сервис реализован на базе **FastAPI** и используется фронтендом/ботом как единая точка входа.

---

## 1. Зависимости и окружение

API-сервис не работает автономно, он опирается на следующие компоненты стека:

- **Elasticsearch** – индекс `chunks` с фрагментами текста и (опционально) эмбеддингами;
- **Vectorizer** – HTTP-сервис эмбеддингов (`/embed`), по умолчанию `http://vectorizer:8001`;
- **MinIO (S3)** – хранилище PDF и результатов квизов;
- **Kafka** – очереди задач квизов и парсинга;
- **LLM-сервер (llama.cpp)** – HTTP-интерфейс `v1/chat/completions` (Qwen 2.5).

Во всех стандартных сценариях запуск выполняется через корневой `docker-compose.yml` проекта.

---

## 2. Запуск API

### 2.1. Через Docker Compose (рекомендуется)

В корне проекта:

```bash
docker compose up -d api
````

Сервис будет доступен по адресу:

```text
http://localhost:8000
```

### 2.2. Локальный запуск (без Docker)

Только для разработки.

1. Установить зависимости:

```bash
cd services/api
pip install -r requirements.txt
```

2. Задать переменные окружения (см. раздел ниже) или создать `.env` рядом с кодом.

3. Запустить сервис:

```bash
uvicorn app.api.main:app --host 0.0.0.0 --port 8000 --reload
```

---

## 3. Переменные окружения

Ниже приведены основные переменные окружения, используемые API.

### 3.1. Общие настройки

| Переменная | Назначение                             | Значение по умолчанию |
| ---------- | -------------------------------------- | --------------------- |
| `APP_ENV`  | Режим окружения (`dev`, `prod` и т.п.) | `dev`                 |

### 3.2. Elasticsearch и поиск

| Переменная | Назначение        | Значение по умолчанию       |
| ---------- | ----------------- | --------------------------- |
| `ES_URL`   | URL Elasticsearch | `http://elasticsearch:9200` |

Используется для текстового поиска и доступа к индексу `chunks`.

### 3.3. Векторизатор (эмбеддинги)

| Переменная       | Назначение                       | Значение по умолчанию    |
| ---------------- | -------------------------------- | ------------------------ |
| `VECTORIZER_URL` | Базовый URL сервиса эмбеддингов  | `http://vectorizer:8001` |
| `EMBEDDINGS_URL` | Полный URL эндпоинта эмбеддингов | `<VECTORIZER_URL>/embed` |

### 3.4. S3 / MinIO

| Переменная      | Назначение                       | Значение по умолчанию / источник                          |
| --------------- | -------------------------------- | --------------------------------------------------------- |
| `S3_ENDPOINT`   | URL S3 совместимого хранилища    | `MINIO_ENDPOINT` или `http://minio:9000`                  |
| `S3_ACCESS_KEY` | access key для S3                | `MINIO_ACCESS_KEY` / `MINIO_ROOT_USER` / `minioadmin`     |
| `S3_SECRET_KEY` | secret key для S3                | `MINIO_SECRET_KEY` / `MINIO_ROOT_PASSWORD` / `minioadmin` |
| `S3_BUCKET`     | имя бакета для данных ассистента | `MINIO_BUCKET` или `assistant-teacher`                    |

S3 используется для:

* хранения PDF-материалов (обрабатываются воркерами);
* хранения квизов и результатов их проверки.

### 3.5. Kafka и квизы

| Переменная                | Назначение                              | Значение по умолчанию                                  |
| ------------------------- | --------------------------------------- | ------------------------------------------------------ |
| `KAFKA_BOOTSTRAP`         | адрес брокера Kafka                     | `kafka:9092`                                           |
| `KAFKA_BOOTSTRAP_SERVERS` | альтернативное имя той же настройки     | пусто (если не задано, используется `KAFKA_BOOTSTRAP`) |
| `TOPIC_GEN_REQ`           | топик запросов на генерацию квизов      | `quizzes.generate`                                     |
| `TOPIC_GEN_DONE`          | топик уведомлений о готовности квизов   | `quizzes.generated`                                    |
| `TOPIC_GRADE_REQ`         | топик запросов на оценку квизов         | `quizzes.grade`                                        |
| `TOPIC_GRADE_DONE`        | топик уведомлений о готовности проверки | `quizzes.graded`                                       |

Если переменные `TOPIC_*` не заданы, используются значения из `docker-compose.yml`.

### 3.6. LLM-сервер

| Переменная  | Назначение                             | Значение по умолчанию                       |
| ----------- | -------------------------------------- | ------------------------------------------- |
| `LLM_URL`   | URL эндпоинта `v1/chat/completions`    | `http://generator:8002/v1/chat/completions` |
| `LLM_MODEL` | Имя модели (логическое, для протокола) | `qwen2.5-7b-instruct`                       |

Используется в модулях:

* `answers.py` – RAG-ответы;
* `summary.py` – суммаризация лекций;
* `assistant.py` – роутер режимов;
* `rephrase_client.py` – переформулирование;
* `translate.py` / `routes_translate_llm.py` – перевод.

### 3.7. Перевод

| Переменная         | Назначение                                          | Значение по умолчанию        |
| ------------------ | --------------------------------------------------- | ---------------------------- |
| `TRANSLATION_MODE` | режим перевода (`auto` / `off`)                     | `auto`                       |
| `RU_EN_MODEL`      | модель HF для перевода RU→EN (оффлайн-режим поиска) | `Helsinki-NLP/opus-mt-ru-en` |
| `EN_RU_MODEL`      | модель HF для перевода EN→RU (fallback)             | `Helsinki-NLP/opus-mt-en-ru` |

---

## 4. HTTP-интерфейс

Ниже приведён обзор основных эндпоинтов. Все запросы и ответы – в формате JSON.

Базовый URL: `http://localhost:8000`.

### 4.1. Health-проверка

#### `GET /health`

Проверка доступности сервиса и S3-бакета.

**Ответ**:

```json
{
  "status": "ok"
}
```

---

### 4.2. Ответы на вопросы по материалам (RAG)

Реализовано в `answers.py`.

#### `POST /answer`

Возвращает краткий ответ на вопрос студента на основе материалов курса.

**Тело запроса** (`AnswerRequest`):

```json
{
  "course_id": "demo",
  "query": "Текст вопроса",
  "k": 5,
  "num_candidates": 256,
  "with_rerank": false
}
```

* `course_id` – идентификатор курса;
* `query` – вопрос;
* `k` – количество фрагментов для контекста;
* `num_candidates` – число кандидатов knn в Elasticsearch;
* `with_rerank` – зарезервировано под кросс-ранжирование (пока не используется).

**Ответ** (`AnswerResponse`):

```json
{
  "answer": "Краткий ответ по материалам курса",
  "sources": [
    {
      "filename": "lecture1.pdf",
      "page": 3,
      "score": 12.34,
      "snippet": "Фрагмент текста…"
    }
  ]
}
```

---

### 4.3. Поиск

Реализовано в `search.py`.

#### `POST /search/text`

Полнотекстовый поиск по полю `content` с фильтром по `course_id`.

**Запрос (`TextSearch`):**

```json
{
  "course_id": "demo",
  "query": "ключевые слова",
  "size": 5
}
```

**Ответ:**

Сырой ответ Elasticsearch с подсветкой (`highlight`).

#### `POST /search/knn`

Семантический поиск с эмбеддингами.

**Запрос (`KnnSearch`):**

```json
{
  "course_id": "demo",
  "query": "текст запроса",
  "k": 5,
  "num_candidates": 256
}
```

Сервис:

1. получает эмбеддинг запроса от `vectorizer`;
2. выполняет knn-поиск в индексе `chunks`;
3. возвращает сырой ответ Elasticsearch.

---

### 4.4. Суммаризация лекций

Реализовано в `summary.py`.

#### `POST /summary/lecture`

Суммаризация лекции по `material_id` или имени файла.

**Запрос (`LectureSummaryRequest`):**

```json
{
  "course_id": "demo",
  "material_id": "optional-id",
  "filename": "lecture1.pdf",
  "max_chars": 8000
}
```

**Ответ (`LectureSummaryResponse`):**

```json
{
  "summary": "Краткое содержание лекции…",
  "chunks_used": 42,
  "pages_covered": [1, 2, 3],
  "material_id": "…",
  "filename": "lecture1.pdf"
}
```

#### `POST /summary/by_query`

Поиск наиболее подходящей лекции по запросу и её суммаризация.

**Запрос (`LectureSummaryByQueryRequest`):**

```json
{
  "course_id": "demo",
  "query": "описание лекции или темы",
  "max_chars": 8000
}
```

**Ответ** – тот же формат `LectureSummaryResponse`.

---

### 4.5. Генерация и получение квизов

Реализовано в `main.py` (эндпоинты `/quizzes/*`) и `generator_worker.py`.

#### `POST /quizzes/generate`

Создание задачи на генерацию квиза.

**Запрос (`GenerateQuizRequest`):**

```json
{
  "course_id": "demo",
  "topics": ["тема 1", "тема 2"],
  "n": 5,
  "types": ["mcq", "cloze", "tf", "short"]
}
```

* `topics` – список тем (может быть `null`, тогда квиз по всему курсу);
* `n` – желаемое количество вопросов;
* `types` – опциональные типы вопросов (пока используются на уровне подсказки для LLM).

**Ответ (`GenerateQuizResponse`):**

```json
{
  "job_id": "uuid",
  "status": "queued"
}
```

#### `GET /quizzes/result/{job_id}`

Получение результата генерации квиза.

**Ответ (`JobStatus`):**

```json
{
  "job_id": "uuid",
  "status": "ready",
  "payload": {
    "course_id": "demo",
    "count": 5,
    "items": [ /* массив вопросов */ ]
  }
}
```

Если квиз ещё не готов, возвращается `status: "pending"`.

---

### 4.6. Оценка квизов

Реализовано в `main.py` (эндпоинты `/quizzes/grade*`) и `grader_worker.py`.

#### `POST /quizzes/grade`

Создание задачи на проверку ответов.

**Запрос (`GradeRequest`):**

```json
{
  "job_id": "quiz_job_id",
  "answers": [0, 1, "ответ", true]
}
```

**Ответ (`GenerateQuizResponse`):**

```json
{
  "job_id": "grade_job_id",
  "status": "queued"
}
```

#### `GET /quizzes/grade/{job_id}`

Получение результата проверки.

**Ответ (`JobStatus`):**

```json
{
  "job_id": "grade_job_id",
  "status": "ready",
  "payload": {
    "right": 3,
    "total": 5,
    "details": [
      {
        "q": "текст вопроса",
        "given": "ответ студента",
        "ok": true
      }
    ]
  }
}
```

---

### 4.7. Переформулирование текста

Реализовано в `routes_rephrase.py` и `rephrase_client.py`.

#### `POST /rephrase`

Переформулирование текста с целью упростить и сократить объяснение.

**Запрос (`RephraseRequest`):**

```json
{
  "text": "Сложный текст для студента…"
}
```

**Ответ (`RephraseResponse`):**

```json
{
  "text": "Список маркеров с упрощённым объяснением…"
}
```

---

### 4.8. Перевод (EN → RU)

Реализовано в `routes_translate_llm.py`.

#### `POST /translate/en-ru`

Перевод текста с английского на русский с помощью LLM.

**Запрос (`TranslateEnRuRequest`):**

```json
{
  "text": "English text to translate…"
}
```

**Ответ (`TranslateEnRuResponse`):**

```json
{
  "text": "Русский перевод…"
}
```

Отдельно в `translate.py` реализована логика обработки команд вида
«переведи на русский …», которая используется в других эндпоинтах.

---

### 4.9. Универсальный ассистент

Реализовано в `assistant.py`.

#### `POST /assistant`

Режим, в котором LLM выбирает, что именно нужно сделать с запросом.

**Запрос (`AssistantRequest`):**

```json
{
  "course_id": "demo",
  "query": "Текст запроса",
  "k": 5,
  "num_candidates": 256,
  "quiz_n": 5
}
```

**Ответ (`AssistantResponse`):**

```json
{
  "mode": "rag_answer | summary_by_query | quiz_generate | rephrase | translate_en_ru",
  "result": { /* данные, соответствующие выбранному режиму */ },
  "router_plan": { /* JSON-план, возвращённый LLM-маршрутизатором */ }
}
```

Если `course_id` не указан, режимы, требующие доступа к материалам курса, могут быть автоматически заменены на `rephrase`.

---

## 5. Безопасность

В API реализованы базовые механизмы защиты:

* фильтрация типовых prompt-инъекций (`guard_input`);
* сканирование текстов на наличие шаблонов секретов (`scan_secrets`);
* при обнаружении возможных секретов в исходных данных или ответе:

  * ответ может быть заменён на служебное сообщение о блокировке.

---

Этот документ описывает интерфейс **Assistant-Teacher API** и служит основой для интеграции клиента (веб-приложения, бота и т.п.) с серверной частью системы.