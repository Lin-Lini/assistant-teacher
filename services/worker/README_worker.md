# Worker service

Сервис **Worker** представляет собой набор фоновых процессов (воркеров),
которые обрабатывают задачи из Kafka и взаимодействуют с MinIO,
Elasticsearch, сервисом эмбеддингов и LLM.  

В состав входят три основных воркера:

- `parser_worker` – парсинг и индексирование учебных материалов (PDF);
- `generator_worker` – генерация квизов по материалам курса;
- `grader_worker` – оценка ответов студентов на квизы.

Воркеры не предоставляют HTTP-интерфейс и запускаются как отдельные
фоновые процессы внутри контейнера.

---

## 1. Назначение воркеров

### 1.1. `parser_worker.py`

Функции:

- чтение сообщений из Kafka-топика `materials.parse`;
- скачивание PDF-файлов из MinIO (S3);
- извлечение текста со страниц PDF (PyMuPDF) с возможным OCR (pytesseract);
- нарезка текста на фрагменты (чанки);
- получение эмбеддингов для фрагментов через сервис Vectorizer;
- индексирование фрагментов в Elasticsearch в индекс `chunks`.

Результат: в индексе `chunks` появляются документы с полями:

- `course_id` – идентификатор курса;
- `material_id` – идентификатор материала (генерируется воркером);
- `filename` – имя файла;
- `page` – номер страницы (с 1);
- `content` – текстовый фрагмент;
- `vector` – векторное представление (массив чисел).

---

### 1.2. `generator_worker.py`

Функции:

- чтение запросов на генерацию квиза из Kafka-топика `quizzes.generate`;
- выборка релевантных фрагментов курса из Elasticsearch;
- формирование контекста по материалам курса;
- генерация квиза с помощью LLM (через HTTP-интерфейс `LLM_URL`);
- сохранение сгенерированного квиза в MinIO;
- отправка уведомления о готовности в Kafka-топик `quizzes.generated`.

Результат:

- в бакете S3/MinIO по пути `quizzes/{job_id}/quiz.json` сохраняется
  структура квиза (массив вопросов);
- по пути `quizzes/{job_id}/status.json` сохраняется статус `{"status": "ready"}`;
- в Kafka публикуется сообщение с `job_id` и статусом.

---

### 1.3. `grader_worker.py`

Функции:

- чтение задач на проверку из Kafka-топика `quizzes.grade`;
- загрузка соответствующего квиза из MinIO (`quizzes/{quiz_job_id}/quiz.json`);
- сравнение ответов студента с эталонными ответами;
- подсчёт количества правильных ответов и формирование детальной статистики;
- сохранение результата проверки в MinIO;
- отправка уведомления о готовности в Kafka-топик `quizzes.graded`.

Результат:

- в бакете S3/MinIO по пути `grades/{grade_job_id}/result.json` сохраняется итог проверки;
- по пути `grades/{grade_job_id}/status.json` – статус `{"status": "ready"}`;
- в Kafka публикуется сообщение с `job_id` и статусом.

---

## 2. Запуск

### 2.1. Через Docker Compose

В штатной конфигурации воркеры запускаются одним контейнером
(разными процессами внутри). Достаточно выполнить:

```bash
docker compose up -d worker
````

Контейнер автоматически подключается к тем же сетям и сервисам, что и API:

* Kafka;
* MinIO;
* Elasticsearch;
* LLM-сервер (для генератора);
* Vectorizer (для парсера).

### 2.2. Ручной запуск (для отладки)

Для локальной отладки возможен прямой запуск каждого воркера:

```bash
cd services/worker

# parser_worker
python -m app.workers.parser_worker

# generator_worker
python -m app.workers.generator_worker

# grader_worker
python -m app.workers.grader_worker
```

Перед запуском необходимо задать переменные окружения (см. раздел 3) и
обеспечить доступ к Kafka, MinIO, Elasticsearch и LLM.

---

## 3. Переменные окружения

Часть переменных общая для всех воркеров, часть – специфична.

### 3.1. Общие настройки S3 / MinIO

Используются во всех трёх воркерах.

| Переменная      | Назначение                       | Значение по умолчанию / источник                                            |
| --------------- | -------------------------------- | --------------------------------------------------------------------------- |
| `S3_ENDPOINT`   | URL S3/MinIO                     | `MINIO_ENDPOINT` или `http://minio:9000`                                    |
| `S3_ACCESS_KEY` | Access key                       | `S3_ACCESS_KEY` / `MINIO_ACCESS_KEY` / `MINIO_ROOT_USER` / `minioadmin`     |
| `S3_SECRET_KEY` | Secret key                       | `S3_SECRET_KEY` / `MINIO_SECRET_KEY` / `MINIO_ROOT_PASSWORD` / `minioadmin` |
| `S3_BUCKET`     | Имя бакета для данных ассистента | `S3_BUCKET` / `MINIO_BUCKET` / `assistant-teacher`                          |

---

### 3.2. Общие настройки Kafka

Используются во всех воркерах.

| Переменная        | Назначение          | Значение по умолчанию |
| ----------------- | ------------------- | --------------------- |
| `KAFKA_BOOTSTRAP` | Адрес брокера Kafka | `kafka:9092`          |

---

### 3.3. Настройки `parser_worker.py`

| Переменная              | Назначение                                          | Значение по умолчанию          |
| ----------------------- | --------------------------------------------------- | ------------------------------ |
| `MATERIALS_PARSE_TOPIC` | Kafka-топик с задачами парсинга материалов          | `materials.parse`              |
| `PARSER_GROUP_ID`       | group id consumer-а парсера                         | `parser-group`                 |
| `ES_URL`                | URL Elasticsearch                                   | `http://elasticsearch:9200`    |
| `ES_INDEX_CHUNKS`       | Имя индекса для чанков                              | `chunks`                       |
| `EMBEDDINGS_URL`        | URL эндпоинта для получения эмбеддингов             | `http://vectorizer:8001/embed` |
| `TESS_LANG`             | Языки OCR (формат Tesseract, например `eng`, `rus`) | `eng`                          |
| `CHUNK_SIZE`            | Размер текстового фрагмента (символов)              | `800`                          |
| `CHUNK_OVERLAP`         | Перекрытие между фрагментами                        | `120`                          |

Сообщения, ожидаемые из Kafka (`MATERIALS_PARSE_TOPIC`), имеют формат JSON, например:

```json
{
  "course_id": "demo",
  "bucket": "assistant-teacher",
  "key": "materials/lecture1.pdf",
  "filename": "lecture1.pdf"
}
```

---

### 3.4. Настройки `generator_worker.py`

| Переменная       | Назначение                               | Значение по умолчанию                       |
| ---------------- | ---------------------------------------- | ------------------------------------------- |
| `TOPIC_GEN_REQ`  | Топик запросов на генерацию квиза        | `quizzes.generate`                          |
| `TOPIC_GEN_DONE` | Топик уведомлений о готовности квиза     | `quizzes.generated`                         |
| `ES_URL`         | URL Elasticsearch                        | `http://elasticsearch:9200`                 |
| `ES_INDEX`       | Имя индекса, из которого берётся контент | `chunks`                                    |
| `LLM_URL`        | URL LLM-сервера (`v1/chat/completions`)  | `http://generator:8002/v1/chat/completions` |
| `LLM_MODEL`      | Логическое имя используемой модели       | `qwen2.5-7b-instruct`                       |

Сообщения в топике `TOPIC_GEN_REQ` имеют вид:

```json
{
  "job_id": "uuid",
  "course_id": "demo",
  "topics": ["тема 1", "тема 2"],
  "n": 5
}
```

Воркера:

1. по темам `topics` делает поисковые запросы в Elasticsearch по полям
   `content` и `filename`;

2. строит текстовый контекст;

3. запрашивает у LLM массив вопросов (JSON-массив);

4. сохраняет квиз в MinIO:

   * `quizzes/{job_id}/quiz.json` – тело квиза;
   * `quizzes/{job_id}/status.json` – `{"status": "ready"}`.

5. публикует в `TOPIC_GEN_DONE` сообщение:

```json
{
  "job_id": "uuid",
  "status": "ready"
}
```

---

### 3.5. Настройки `grader_worker.py`

| Переменная         | Назначение                            | Значение по умолчанию |
| ------------------ | ------------------------------------- | --------------------- |
| `TOPIC_GRADE_REQ`  | Топик запросов на оценку квизов       | `quizzes.grade`       |
| `TOPIC_GRADE_DONE` | Топик уведомлений о готовности оценки | `quizzes.graded`      |

Сообщения в `TOPIC_GRADE_REQ`:

```json
{
  "job_id": "quiz_job_id",
  "grade_job_id": "grade_job_id",
  "answers": [0, 1, "ответ", true]
}
```

Воркер:

1. загружает квиз из MinIO по пути `quizzes/{job_id}/quiz.json`;
2. сравнивает ответы студента с эталонными:

   * для `cloze` – по строкам (в нижнем регистре, с обрезкой пробелов);
   * для `tf` – по булевому значению;
   * для остальных типов – по строковому совпадению;
3. формирует результат:

```json
{
  "right": 3,
  "total": 5,
  "details": [
    {
      "q": "текст вопроса",
      "given": "ответ студента",
      "ok": true
    }
  ]
}
```

4. сохраняет результат в MinIO:

   * `grades/{grade_job_id}/result.json`;
   * `grades/{grade_job_id}/status.json` (статус `ready`);

5. отправляет уведомление в `TOPIC_GRADE_DONE`:

```json
{
  "job_id": "grade_job_id",
  "status": "ready"
}
```

---

## 4. Потоки данных

### 4.1. Индексирование материалов

1. PDF-файл загружается в MinIO.
2. В Kafka в топик `materials.parse` отправляется сообщение с указанием
   `course_id`, `bucket` и `key`.
3. `parser_worker`:

   * скачивает файл,
   * извлекает текст и выполняет OCR (при необходимости),
   * строит чанки,
   * запрашивает эмбеддинги у Vectorizer,
   * индексирует фрагменты в Elasticsearch (`ES_INDEX_CHUNKS`).

---

### 4.2. Генерация квиза

1. API-сервис по запросу преподавателя создаёт задачу в топике `quizzes.generate`.
2. `generator_worker` читает задачу, формирует контекст и запрашивает у LLM
   массив вопросов в формате JSON.
3. Сгенерированный квиз сохраняется в MinIO, и в топик `quizzes.generated`
   отправляется уведомление.
4. API по запросу клиента (`GET /quizzes/result/{job_id}`) считывает квиз из MinIO
   и возвращает его фронтенду.

---

### 4.3. Оценка квиза

1. API получает от клиента ответы студента и создаёт задачу в топике `quizzes.grade`.
2. `grader_worker`:

   * загружает квиз из MinIO,
   * вычисляет число правильных ответов и формирует детальный отчёт,
   * сохраняет результат и статус в MinIO,
   * отправляет уведомление в топик `quizzes.graded`.
3. API по запросу клиента (`GET /quizzes/grade/{job_id}`) возвращает результат проверки.

---

Этот документ описывает назначение и конфигурацию сервиса **Worker**
в составе проекта Assistant-Teacher и предназначен для разработчиков и
администраторов, поддерживающих рабочий стек микросервисов.