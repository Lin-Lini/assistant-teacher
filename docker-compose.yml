services:
  elasticsearch:
    image: elasticsearch:8.15.3
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    ports:
      - "9200:9200"
    volumes:
      - esdata:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD","curl","-fsSL","http://localhost:9200/"]
      interval: 10s
      timeout: 5s
      retries: 20

  zookeeper:
    image: zookeeper:3.9.4
    container_name: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOO_4LW_COMMANDS_WHITELIST: "ruok,stat,srvr,conf,envi,isro"

  kafka:
    image: confluentinc/cp-kafka:7.7.6
    container_name: kafka
    restart: unless-stopped
    depends_on:
      zookeeper:
        condition: service_started
    ports:
      - "9092:9092"
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_HEAP_OPTS: -Xmx512m -Xms512m
    healthcheck:
      test: ["CMD","bash","-lc","kafka-broker-api-versions --bootstrap-server localhost:9092 >/dev/null 2>&1"]
      interval: 10s
      timeout: 10s
      retries: 30

  minio:
    image: minio/minio:latest
    container_name: minio
    restart: unless-stopped
    command: server --console-address ':9001' /data
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio:/data
    healthcheck:
      test: ["CMD","curl","-fsSL","http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 20

  es-init:
    image: curlimages/curl:8.8.0
    depends_on:
      elasticsearch:
        condition: service_healthy
    volumes:
      - ./infra/chunks.json:/tmp/chunks.json:ro
    command: >
      sh -lc '
        set -e
        if curl -sfI http://elasticsearch:9200/chunks >/dev/null; then
          echo "index chunks exists, skip";
        else
          echo "creating index chunks";
          curl -fsS -X PUT http://elasticsearch:9200/chunks \
            -H "Content-Type: application/json" \
            --data-binary @/tmp/chunks.json;
        fi
      '
    restart: "no"

  kafka-init:
    image: confluentinc/cp-kafka:7.7.6
    depends_on:
      kafka:
        condition: service_started
    entrypoint: ["/bin/bash","-lc"]
    command: >
      set -e;
      for i in {1..40}; do
        kafka-topics --bootstrap-server kafka:9092 --list >/dev/null 2>&1 && break;
        echo "waiting for kafka... $i";
        sleep 2;
      done;
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic materials.parse   --partitions 3 --replication-factor 1;
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic quizzes.generate  --partitions 3 --replication-factor 1;
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic quizzes.generated --partitions 3 --replication-factor 1;
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic quizzes.grade     --partitions 3 --replication-factor 1;
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic quizzes.graded    --partitions 3 --replication-factor 1;
    restart: "no"

  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: ["/bin/sh","-lc"]
    command: |
      set -e
      mc alias set local http://minio:9000 ${MINIO_ROOT_USER:-minioadmin} ${MINIO_ROOT_PASSWORD:-minioadmin}
      mc mb -p local/assistant-teacher || true
      mc anonymous set none local/assistant-teacher || true
      mc ls local
    restart: "no"

  generator:
    image: ghcr.io/ggerganov/llama.cpp:server
    command: >
      -m /models/qwen2.5-1.5b-instruct-q4_k_m.gguf
      -t 8 -c 2048 -ngl 0
      --host 0.0.0.0 --port 8002
      --jinja
    volumes:
      - ./models:/models:ro
    ports:
      - "8002:8002"
    environment:
      LLAMA_ARG_CHAT_TEMPLATE: ""
      LLAMA_ARG_HOST: ""
    healthcheck:
      test: ["CMD","sh","-lc","curl -fsS http://localhost:8002/v1/models >/dev/null || curl -fsS http://localhost:8002/health >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 120

  vectorizer:
    build:
      context: ./services/vectorizer
    container_name: vectorizer
    restart: unless-stopped
    volumes:
      - ./data/hf-cache:/models
    environment:
      MODEL_NAME: sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2
      MODEL_CACHE: /models
      TRANSLATE_ENABLED: "0"
    ports:
      - "8001:8001"
    healthcheck:
      test: ["CMD","curl","-fsSL","http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 15

  api:
    build:
      context: ./services/api
    container_name: api
    restart: unless-stopped
    environment:
      LLM_URL: http://generator:8002/v1/chat/completions
      KAFKA_BOOTSTRAP: kafka:9092
      TOPIC_QUIZZES_GENERATE: quizzes.generate
      TOPIC_QUIZZES_GENERATED: quizzes.generated
      TOPIC_QUIZZES_GRADE: quizzes.grade
      TOPIC_QUIZZES_GRADED: quizzes.graded
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_BUCKET: assistant-teacher
      ES_URL: http://elasticsearch:9200
      ES_INDEX_CHUNKS: chunks
      EMBEDDINGS_URL: http://vectorizer:8001/embed
      TRANSLATE_URL: http://vectorizer:8001/translate
    ports:
      - "8000:8000"
    depends_on:
      generator:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      es-init:
        condition: service_completed_successfully
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
      zookeeper:
        condition: service_started
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
      vectorizer:
        condition: service_started
    command: uvicorn app.api.main:app --host 0.0.0.0 --port 8000
    healthcheck:
      test: ["CMD","curl","-fsSL","http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 15

  worker-parser:
    build:
      context: ./services/worker
    container_name: worker-parser
    restart: unless-stopped
    environment:
      PYTHONPATH: /app/app
      KAFKA_BOOTSTRAP: kafka:9092
      MATERIALS_PARSE_TOPIC: materials.parse
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_BUCKET: assistant-teacher
      ES_URL: http://elasticsearch:9200
      ES_INDEX_CHUNKS: chunks
      EMBEDDINGS_URL: http://vectorizer:8001/embed
      TESS_LANG: rus+eng
      LLM_URL: http://generator:8002/v1/chat/completions
    depends_on:
      zookeeper:
        condition: service_started
      kafka:
        condition: service_healthy
      minio:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    command: python -m app.workers.parser_worker

  worker-generator:
    build:
      context: ./services/worker
    container_name: worker-generator
    restart: unless-stopped
    environment:
      PYTHONPATH: /app/app
      KAFKA_BOOTSTRAP: kafka:9092
      TOPIC_GEN_REQ: quizzes.generate
      TOPIC_GEN_DONE: quizzes.generated
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_BUCKET: assistant-teacher
      ES_URL: http://elasticsearch:9200
      ES_INDEX: chunks
      LLM_URL: http://generator:8002/v1/chat/completions
    depends_on:
      zookeeper:
        condition: service_started
      kafka:
        condition: service_healthy
      minio:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    command: python -m app.workers.generator_worker

  worker-grader:
    build:
      context: ./services/worker
    container_name: worker-grader
    restart: unless-stopped
    environment:
      PYTHONPATH: /app/app
      KAFKA_BOOTSTRAP: kafka:9092
      TOPIC_GRADE_REQ: quizzes.grade
      TOPIC_GRADE_DONE: quizzes.graded
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_BUCKET: assistant-teacher
      ES_URL: http://elasticsearch:9200
      ES_INDEX_CHUNKS: chunks
      LLM_URL: http://generator:8002/v1/chat/completions
    depends_on:
      zookeeper:
        condition: service_started
      kafka:
        condition: service_healthy
      minio:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    command: python -m app.workers.grader_worker

volumes:
  esdata:
  minio:
